<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Render Cloud Demo</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>

<header class="topbar">
  <div class="brand">
    <h1>Render Cloud Demo</h1>
    <p class="sub">Simple cloud metrics & CPU load simulator</p>
  </div>

  <div class="actions">
    <label>Burn ms:
      <input id="burnMs" type="number" value="800" min="50" step="50" />
    </label>
    <button id="burnBtn" class="btn">Trigger Burn</button>
    <button id="burstBtn" class="btn alt">Burst (5x)</button>
    <a class="btn link" href="/status" target="_blank">Raw /status</a>
  </div>
</header>

<main class="container">
  <section class="left">
    <div class="card">
      <h2>Live Metrics</h2>
      <div class="metrics-grid">

        <div class="metric">
          <div class="label">Uptime</div>
          <div id="uptime" class="value">-</div>
        </div>

        <div class="metric">
          <div class="label">CPU cores</div>
          <div id="cpus" class="value">-</div>
        </div>

        <div class="metric">
          <div class="label">CPU Usage</div>
          <div id="cpu_val" class="value">- %</div>
        </div>

        <div class="metric">
          <div class="label">RSS Memory</div>
          <div id="rss" class="value">- MB</div>
        </div>

        <div class="metric">
          <div class="label">Heap Used</div>
          <div id="heap" class="value">- MB</div>
        </div>

      </div>
    </div>

    <div class="card">
      <h2>CPU / Memory History</h2>
      <canvas id="chart" height="160"></canvas>
    </div>
  </section>

  <aside class="right">
    <div class="card">
      <h2>Actions / Demo</h2>
      <p>Simulate cloud usage spikes using CPU burn.</p>
      <ol>
        <li>Set burn milliseconds (e.g., 800 ms)</li>
        <li>Click Trigger Burn</li>
        <li>Or click Burst (5x) for concurrency</li>
      </ol>
    </div>

    <div class="card small">
      <h3>Recent Events</h3>
      <ul id="events" class="events"></ul>
    </div>
  </aside>
</main>

<footer class="footer">
  <small>Live metrics update every 2 seconds</small>
</footer>

<script>
(() => {
  const statusUrl = "/status";

  const maxPoints = 40;
  const labels = [];
  const cpuData = [];
  const rssData = [];
  const heapData = [];

  const chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "CPU %",
          data: cpuData,
          borderColor: "#ef4444",
          borderWidth: 2,
          tension: 0.3
        },
        {
          label: "RSS (MB)",
          data: rssData,
          borderColor: "#60a5fa",
          borderWidth: 2,
          tension: 0.3
        },
        {
          label: "Heap Used (MB)",
          data: heapData,
          borderColor: "#f472b6",
          borderWidth: 2,
          tension: 0.3
        }
      ]
    },
    options: { animation: false, responsive: true }
  });

  const eventsEl = document.getElementById("events");

  function addEvent(msg) {
    const li = document.createElement("li");
    li.innerText = new Date().toLocaleTimeString() + " â€” " + msg;
    eventsEl.prepend(li);
    while (eventsEl.children.length > 12) eventsEl.removeChild(eventsEl.lastChild);
  }

  async function fetchStatus() {
    try {
      const res = await fetch(statusUrl);
      const s = await res.json();

      document.getElementById("uptime").innerText = s.uptime_s + " s";
      document.getElementById("cpus").innerText = s.cpus;

      const cpuBox = document.getElementById("cpu_val");
      cpuBox.innerText = s.cpu_percent + " %";

      if (s.cpu_percent < 30) cpuBox.style.color = "#4ade80";
      else if (s.cpu_percent < 70) cpuBox.style.color = "#facc15";
      else cpuBox.style.color = "#ef4444";

      document.getElementById("rss").innerText = s.memory_rss_mb + " MB";
      document.getElementById("heap").innerText = s.memory_heap_used_mb + " MB";

      labels.push(new Date(s.timestamp).toLocaleTimeString());
      cpuData.push(s.cpu_percent);
      rssData.push(s.memory_rss_mb);
      heapData.push(s.memory_heap_used_mb);

      if (labels.length > maxPoints) {
        labels.shift(); cpuData.shift(); rssData.shift(); heapData.shift();
      }

      chart.update();
    } catch {
      addEvent("Error fetching /status");
    }
  }

  setInterval(fetchStatus, 2000);
  fetchStatus();

  document.getElementById("burnBtn").onclick = async () => {
    const ms = Number(document.getElementById("burnMs").value);
    addEvent("Triggering burn " + ms + "ms");
    await fetch("/burn?ms=" + ms);
    addEvent("Burn finished");
  };

  document.getElementById("burstBtn").onclick = () => {
    const ms = Number(document.getElementById("burnMs").value);
    addEvent("Burst x5 (" + ms + "ms)");
    for (let i = 0; i < 5; i++) fetch("/burn?ms=" + ms);
  };
})();
</script>

</body>
</html>
